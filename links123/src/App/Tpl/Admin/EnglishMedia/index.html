<tagLib name="html" />
<include file="Public:header" />

<load href="__PUBLIC__/Js/Jquery/jquery.js" />
<load href="__PUBLIC__/Js/My97DatePicker/WdatePicker.js" />
<load href="__PUBLIC__/skin/easyui/themes/metro/easyui.css" />
<load href="__PUBLIC__/Js/Jquery/jqueryform.js" />
<load href="__PUBLIC__/skin/easyui/locale/easyui-lang-zh_CN.js" /> 
<load href="__PUBLIC__/skin/easyui/jquery.easyui.min.js" />

<div id="main" class="main" >
    <div class="content" >
        <div class="title">英语角媒体列表</div>

        <div class="operate" >
            <html:imageBtn name="add" click="add()" style="hMargin fLeft" />
            <html:imageBtn name="edit" click="edit()" style="hMargin fLeft" />
            <html:imageBtn name="forbid" click="forbid()" style="hMargin fLeft" />
            <html:imageBtn name="delete" click="del()" style="hMargin fLeft" />
            <html:imageBtn name="resume" click="resume()" style="hMargin fLeft" />
            <select id="selectSubjectSource" style='float:left;margin:0 5px;'>
                <option value='-1'>选择专题</option>
                <option value='0'>无专题</option>
                <volist name="subject_list" id="subject">
                    <option value="{$subject.id}" <eq name="param['subject']" value="$subject['id']">selected="true"</eq>>{$subject.name}</option>
                </volist>
            </select>&nbsp;&nbsp;
            <label style='float: left; margin: 5px 5px 0px 0px;'>推荐:</label>
            <label style='float: left; margin: 5px 5px 0px 0px;'>是<input style='float: left; margin: 3px 2px 0px 0px;' type='checkbox' value="1" name="recommend"/></label>
            <label style='float: left; margin: 5px 5px 0px 0px;'>否<input style='float: left; margin: 3px 2px 0px 0px;' type='checkbox' value="0" name="recommend"/></label>
            <label style='float: left; margin: 5px 5px 0px 0px;'>特别推荐:</label>
            <label style='float: left; margin: 5px 5px 0px 0px;'>是<input style='float: left; margin: 3px 2px 0px 0px;' type='checkbox' value="1" name="special_recommend"/></label>
            <label style='float: left; margin: 5px 5px 0px 0px;'>否<input style='float: left; margin: 3px 2px 0px 0px;' type='checkbox' value="0" name="special_recommend"/></label>
            <label style='float: left; margin: 5px 5px 0px 0px;'>TED:</label>
            <label style='float: left; margin: 5px 5px 0px 0px;'>是<input style='float: left; margin: 3px 2px 0px 0px;' type='checkbox' value="1" name="ted"/></label>
            <label style='float: left; margin: 5px 5px 0px 0px;'>否<input style='float: left; margin: 3px 2px 0px 0px;' type='checkbox' value="0" name="ted"/></label>
            <label style='float: left; margin: 5px 5px 0px 0px;'>选择等级：</label>
            <select id="selectDifficulty" style='float:left;margin:0 5px;'>
                 <option value="0">全部</option>
                 <option value="1" >初级</option>
                 <option value="2" >中级</option>
                 <option value="3">高级</option>
            </select>
             
            <html:imageBtn name="groupAct" click="groupAct()" style="hMargin fLeft" />
        </div>

        <form method='post' action="__URL__">
            <div class="rSearch" style="margin: 8px 7px">
                <div class="fLeft">媒体查询：<span id="key"><input type="text" autocomplete="off" name="name" value="{$name}" class="medium" /></span></div>
                <html:imageBtn type="submit" name="search" style="hMargin fLeft" />
            </div>
            <div class="search cBoth" style="height: 60px;">
                <div>
                    <label>
                        <input class="checkbox" type="checkbox" value="1" name="pattern" <eq name="param['pattern']" value="1">checked="checked"</eq>>
                        视频
                    </label>
                    <label>
                        <input class="checkbox" type="checkbox" value="2" name="pattern" <eq name="param['pattern']" value="2">checked="checked"</eq>>
                        音频
                    </label>&nbsp;&nbsp;
                    <label>
                        <input class="checkbox" type="checkbox" value="1" name="voice" <eq name="param['voice']" value="1">checked="checked"</eq>>
                        美音
                    </label>
                    <label>
                        <input class="checkbox" type="checkbox" value="2" name="voice" <eq name="param['voice']" value="2">checked="checked"</eq>>
                        英音
                    </label>&nbsp;&nbsp;
                    科目：
                    <select name="object" id="opeartObjectSelect">
                        <volist name="object_list" id="object">
                            <option value="{$object.id}"  <eq name="param['object']" value="$object['id']">selected="true"</eq>>{$object.name}</option>
                        </volist>
                    </select>&nbsp;&nbsp;
                    <select name="level" id="opeartLevelSelect">
                        <option value="0">全部</option>
                        <volist name="level_list" id="level">
                            <option value="{$level.id}" <eq name="param['level']" value="$level['id']">selected="true"</eq>>{$level.name}</option>
                        </volist>
                    </select>
                    &nbsp;&nbsp;
                    专题：
                    <select name="subject">
                        <option value="0">全部</option>
                        <volist name="subject_list" id="subject">
                            <option value="{$subject.id}" <eq name="param['subject']" value="$subject['id']">selected="true"</eq>>{$subject.name}</option>
                        </volist>
                    </select>
                    <select name="difficulty">
                        <option value="0">全部</option>
                        <option value="1" <eq name="param['difficulty']" value="1">selected="true"</eq>>初级</option>
                        <option value="2" <eq name="param['difficulty']" value="2]">selected="true"</eq>>中级</option>
                        <option value="3" <eq name="param['difficulty']" value="3">selected="true"</eq>>高级</option>
                    </select>
                    &nbsp;&nbsp;
                    添加时间：
                    <input type="text" id="J_createTime" name="created" value="{$param['created']}" />
                    &nbsp;&nbsp;
                    
                </div>
                <div style="margin-top: 10px;">
                    推荐：
                    <label>
                        <input class="checkbox" type="checkbox" value="1" name="recommend" <if condition="$param['recommend'] eq 1">checked="checked"</if>>
                        是
                    </label>&nbsp;
                    <label>
                        <input class="checkbox" type="checkbox" value="0" name="recommend" <eq name="param['recommend']" value="0">checked="checked"</eq>>
                        否
                    </label>
                    &nbsp;&nbsp;
                    特别推荐：
                    <label>
                        <input class="checkbox" type="checkbox" value="1" name="special_recommend" <if condition="$param['special_recommend'] eq 1">checked="checked"</if>>
                        是
                    </label>&nbsp;
                    <label>
                        <input class="checkbox" type="checkbox" value="0" name="special_recommend" <eq name="param['special_recommend']" value="0">checked="checked"</eq>>
                        否
                    </label>&nbsp;&nbsp;
                    TED：
                    <label>
                        <input class="checkbox" type="checkbox" value="1" name="ted" <eq name="param['ted']" value="1">checked="checked"</eq>>
                        是
                    </label>&nbsp;
                    <label>
                        <input class="checkbox" type="checkbox" value="0" name="ted" <eq name="param['ted']" value="0">checked="checked"</eq>>
                        否
                    </label>&nbsp;&nbsp;
                    <label>
                        <input class="checkbox" type="checkbox" value="1" name="omg" <eq name="param['omg']" value="1">checked="checked"</eq>>
                        OMG
                    </label>&nbsp;
                    状态：
                    <label>
                        <input class="checkbox" type="checkbox" value="1" name="status" <if condition="$param['status'] eq 1">checked="checked"</if>>
                        正常
                    </label>&nbsp;
                    <label>
                        <input class="checkbox" type="checkbox" value="0" name="status" <eq name="param['status']" value="0">checked="checked"</eq>>
                        禁用
                    </label>&nbsp;
                    <label>
                        <input class="checkbox" type="checkbox" value="-1" name="status" <eq name="param['status']" value="-1">checked="checked"</eq>>
                        已删除
                    </label>&nbsp;&nbsp;
                    缩略图：
                    <label>
                        <input class="checkbox" type="checkbox" value="1" name="thumb" <eq name="param['thumb']" value="1">checked="checked"</eq>>
                        有
                    </label>&nbsp;
                    <label>
                        <input class="checkbox" type="checkbox" value="0" name="thumb" <eq name="param['thumb']" value="0">checked="checked"</eq>>
                        无
                    </label>&nbsp;&nbsp;
                    本地视频：
                    <label>
                        <input class="checkbox" type="checkbox" value="1" name="has_local_path" <eq name="param['has_local_path']" value="1">checked="checked"</eq>>
                        有
                    </label>&nbsp;
                    <label>
                        <input class="checkbox" type="checkbox" value="0" name="has_local_path" <eq name="param['has_local_path']" value="0">checked="checked"</eq>>
                        无
                    </label>
                </div>
            </div>
        </form>

        <div class="list" >
            <html:list id="checkList" name="category" param="{$param}" style="list" checkbox="true" action="true" datasource="list" show="id:编号|5%,name:名称:edit,object_name|default=无:科目:selectObject,level_name|default=无:等级:selectLevel,subject_name|default=无:专题:selectSubject,difficulty|getMediaDifficultyName:难度,recommend|getMediaRecommendYorN:推荐:recommend,special_recommend|getYorN:特别推荐:special_recommend,ted|getMediaRecommendYorN:TED:ted,voice|getVoiceName:语音,pattern|getMediaPatternName:格式类型,play_type|getMediaPlayTypeName:播放类型,priority_type|getMediaPriorityTypeName:优先播放:setMediaPriorityType,media_source_url|getLinkToHrefWithOutHttp:来源地址,created|toDate:发布时间,status|getStatus:状态" actionlist="edit:编辑" />
        </div>

        <div class="page">{$page}</div>

    </div>

</div>
<div id="load_dialog" class="easyui-dialog" style="width:225px;height:auto;" data-options="title:'正在处理',shadow:false,modal:true,closed:true,closable:false">
    <img style="" src="__PUBLIC__/Images/loading.gif" />
</div>
</body>
<script type="text/javascript">
    $(function() {
        $("#J_createTime").focus(function() {
            WdatePicker({dateFmt: 'yyyy-MM-dd', maxDate: "%y-%M-%d", onpicked: function() {
                    $("[name='search']").click();
                }, oncleared: function() {
                    $("[name='search']").click();
                }
            });
            $(this).blur();
        })
        $(".search .checkbox").click(function() {
            $("[name='" + $(this).attr("name") + "']").not("[value='" + $(this).val() + "']").removeAttr("checked");
            $("[name='search']").click();
        })
        $("[name='object'],[name='level'],[name='subject'],[name='difficulty']").change(function() {
            $("[name='search']").click();
        })
        $(".operate input[name='special_recommend']").click(function() {
            if ($(this).val() == 1) {
                if (!$(".operate input[name='recommend'][value='1']").attr("checked")) {
                    $(".operate input[name='recommend']").removeAttr("checked");
                    $(".operate input[name='recommend'][value='1']").attr("checked", "checked");
                }
            }
            $(".operate [name='special_recommend']").not("[value='" + $(this).val() + "']").removeAttr("checked");
        })
        $(".operate input[name='recommend']").click(function() {
            if ($(this).val() == 0) {
                if ($(".operate input[name='special_recommend'][value='1']").attr("checked")) {
                    $(".operate input[name='special_recommend'][value='1']").removeAttr("checked");
                }
            }
            $(".operate [name='recommend']").not("[value='" + $(this).val() + "']").removeAttr("checked");
        })
        $(".operate input[name='ted']").click(function() {
            $(".operate [name='ted']").not("[value='" + $(this).val() + "']").removeAttr("checked");
        })

        /* 直达 */
        $(".page input").keydown(function(event) {
            if (event.keyCode == 13) {	// 回车
                if ($(this).val() != '' && !isNaN($(this).val())) {
                    window.location.href = $(this).attr("url") + "&p=" + $(this).val();
                }
            }
        });
    })
    function groupAct() {
        var id = getSelectCheckboxValues();
        if (!id) {
            alert('请选择操作项！');
            return false;
        }
        var id = getSelectCheckboxValues();
        var targetSubject = $("#selectSubjectSource").val();
        var targetRecommend = $("input[name='recommend']").filter(":checked").val();
        var targetSpecialRecommend = $("input[name='special_recommend']").filter(":checked").val();
        var targetTed = $("input[name='ted']").filter(":checked").val();
        var targetDifficulty = $("#selectDifficulty").val();
        if (parseInt(targetSubject) == -1 && typeof targetRecommend=="undefined" && typeof targetSpecialRecommend=="undefined" && typeof targetTed=="undefined" && typeof targetDifficulty=="undefined") {
            alert("请选择需要设置成的参数！");
            return false;
        }
        if (confirm("注意！确认对所选项进行批量操作？")) {
            $("#load_dialog").window("open");
            $.post("__URL__/groupSet", {id: id, targetSubject: targetSubject, targetRecommend: targetRecommend, targetSpecialRecommend: targetSpecialRecommend,targetTed:targetTed,targetDifficulty:targetDifficulty},
            function(msg) {
                if (msg) {
                    alert(msg.info);
                    if (msg.status) {
                        window.location.reload();
                    }
                }
                $("#load_dialog").window("close");
            }, "json");
        }
    }
    /**
     * 特别推荐
     * @param {int} id 操作对象id
     * @returns {void}
     */
    function special_recommend(id) {
        if (id > 0) {
            $("#load_dialog").window("open");
            $.post("__URL__/setSpecialRecommend", {id: id}, function(msg) {
                if (msg) {
                    if (msg.status) {
                        if (msg.data.special_recommend == 0) {
                            $("a[href=\"javascript:special_recommend('" + id + "')\"]").text("否");
                        } else {
                            if (msg.data.recommend) {
                                $("a[href^=\"javascript:recommend('" + id + "'\"]").text("是");
                            }
                            $("a[href=\"javascript:special_recommend('" + id + "')\"]").text("是");
                        }
                    }
                }
                $("#load_dialog").window("close");
            }, "json");
        } else {
            alert("非法操作！");
        }
    }
    /**
     * 推荐
     * @param {int} id 操作对象id
     * @returns {void}
     */
    function recommend(id) {
        if (id > 0) {
            $("#load_dialog").window("open");
            $.post("__URL__/setRecommend", {id: id}, function(msg) {
                if (msg) {
                    if (msg.status) {
                        if (msg.data == 0) {
                            $("a[href=\"javascript:recommend('" + id + "')\"]").text("否");
                            $("a[href=\"javascript:special_recommend('" + id + "')\"]").text("否");
                        } else {
                            $("a[href=\"javascript:recommend('" + id + "')\"]").text("是");
                        }
                    }
                }
                $("#load_dialog").window("close");
            }, "json");
        } else {
            alert("非法操作！");
        }
    }
    /**
    * 

     * @param {type} id
     * @returns {void}    
     */
    
    function ted(id){
        if (id > 0) {
            $("#load_dialog").window("open");
            $.post("__URL__/setTed", {id: id}, function(msg) {
                if (msg) {
                    if (msg.status) {
                        if (msg.data == 0) {
                            $("a[href=\"javascript:ted('" + id + "')\"]").text("否");
                        } else {
                            $("a[href=\"javascript:ted('" + id + "')\"]").text("是");
                        }
                    }
                }
                $("#load_dialog").window("close");
            }, "json");
        } else {
            alert("非法操作！");
        }
    }
    /**
     * 设置媒体优先播放类型
     * @param {int} id
     * @returns {undefined}
     */
    function setMediaPriorityType(id) {
        if (id > 0) {
            $("#load_dialog").window("open");
            $.post("__URL__/setPriorityType", {id: id}, function(msg) {
                if (msg) {
                    if (msg.status) {
                        if (msg.data == 1) {
                            $("a[href=\"javascript:setMediaPriorityType('" + id + "')\"]").text("外链");
                        } else {
                            $("a[href=\"javascript:setMediaPriorityType('" + id + "')\"]").text("本地");
                        }
                    }
                }
                $("#load_dialog").window("close");
            }, "json");
        } else {
            alert("非法操作！");
        }
    }
    /**
     * 选择专题
     * @param {int} id
     * @returns {void}     
     * @author Adam $date2013.08.30$
     */
    function selectSubject(id) {
        $(".subjectSelect").unbind();
        //现有的select
        var old_select_id = $(".subjectSelect").attr("id");
        //现有的select移除，还原链接
        if (old_select_id) {
            var old_id = old_select_id.substr(old_select_id.indexOf("_") + 1);
            $("#subjectSelect_" + old_id).remove();
            $("a[href=\"javascript:selectSubject('" + old_id + "')\"]").show();
        }
        //显示当前选中的
        var td = $("a[href=\"javascript:selectSubject('" + id + "')\"]").parent("td");
        $("a[href=\"javascript:selectSubject('" + id + "')\"]").hide();
        var now_text = $("a[href=\"javascript:selectSubject('" + id + "')\"]").text();
        td.append("<select class='subjectSelect' id='subjectSelect_" + id + "'></select>");
        $("#subjectSelect_" + id).html($("#selectSubjectSource").html());
        $("#subjectSelect_" + id + " option:contains('" + now_text + "')").attr("selected", "selected");
        //
        //绑定事件
        $(".subjectSelect").change(function() {
            if (parseInt($(this).val()) == -1) {
                return false;
            }
            var select = $(this);
            var id = $(this).attr("id").substr($(this).attr("id").indexOf("_") + 1);
            var target = $(this).val();
            var targetName = $(".subjectSelect option[value='" + target + "']").text();
            $("#load_dialog").window("open");
            $.post("__URL__/pointSubject", {id: id, target: target}, function(msg) {
                if (msg) {
                    if (msg.status) {
                        $("a[href=\"javascript:selectSubject('" + id + "')\"]").text(targetName);
                        select.remove();
                        $("a[href=\"javascript:selectSubject('" + id + "')\"]").show();
                    }
                }
                $("#load_dialog").window("close");
            }, "json")
        })
    }
    
    
    /**
     * 选择科目
     * @param {int} id
     * @returns {void}     
     * @author Adam $date2013.08.30$
     */
    function selectObject(id) {
        $(".objectSelect").unbind();
        //现有的select
        var old_select_id = $(".objectSelect").attr("id");
        //现有的select移除，还原链接
        if (old_select_id) {
            var old_id = old_select_id.substr(old_select_id.indexOf("_") + 1);
            $("#selectObject_" + old_id).remove();
            $("a[href=\"javascript:selectObject('" + old_id + "')\"]").show();
        }
        //显示当前选中的
        var td = $("a[href=\"javascript:selectObject('" + id + "')\"]").parent("td");
        $("a[href=\"javascript:selectObject('" + id + "')\"]").hide();
        var now_text = $("a[href=\"javascript:selectObject('" + id + "')\"]").text();
        td.append("<select class='objectSelect' id='selectObject_" + id + "'></select>");
        $("#selectObject_" + id).html($("#opeartObjectSelect").html());
        $("#selectObject_" + id + " option:contains('综合')").remove();
        $("#selectObject_" + id + " option:contains('" + now_text + "')").attr("selected", "selected");
        //
        //绑定事件
        $(".objectSelect").change(function() {
            if (parseInt($(this).val()) == -1) {
                return false;
            }
            var select = $(this);
            var id = $(this).attr("id").substr($(this).attr("id").indexOf("_") + 1);
            var target = $(this).val();
            var targetName = $(".objectSelect option[value='" + target + "']").text();
            $("#load_dialog").window("open");
            $.post("__URL__/pointObject", {id: id, target: target}, function(msg) {
                if (msg) {
                    if (msg.status) {
                        $("a[href=\"javascript:selectObject('" + id + "')\"]").text(targetName);
                        select.remove();
                        $("a[href=\"javascript:selectObject('" + id + "')\"]").show();
                    }
                }
                $("#load_dialog").window("close");
            }, "json")
        })
    }
    
    
     /**
     * 选择科等级
     * @param {int} id
     * @returns {void}     
     * @author Adam $date2013.08.30$
     */
    function selectLevel(id) {
        $(".levelSelect").unbind();
        //现有的select
        var old_select_id = $(".levelSelect").attr("id");
        //现有的select移除，还原链接
        if (old_select_id) {
            var old_id = old_select_id.substr(old_select_id.indexOf("_") + 1);
            $("#selectLevel_" + old_id).remove();
            $("a[href=\"javascript:selectObject('" + old_id + "')\"]").show();
        }
        //显示当前选中的
        var td = $("a[href=\"javascript:selectLevel('" + id + "')\"]").parent("td");
        $("a[href=\"javascript:selectLevel('" + id + "')\"]").hide();
        var now_text = $("a[href=\"javascript:selectLevel('" + id + "')\"]").text();
        td.append("<select class='levelSelect' id='selectLevel_" + id + "'></select>");
        $("#selectLevel_" + id).html($("#opeartLevelSelect").html());
        $("#selectLevel_" + id+" option[value='0']").text("无");
        $("#selectLevel_" + id + " option:contains('" + now_text + "')").attr("selected", "selected");
        //
        //绑定事件
        $(".levelSelect").change(function() {
            if (parseInt($(this).val()) == -1) {
                return false;
            }
            var select = $(this);
            var id = $(this).attr("id").substr($(this).attr("id").indexOf("_") + 1);
            var target = $(this).val();
            var targetName = $(".levelSelect option[value='" + target + "']").text();
            $("#load_dialog").window("open");
            $.post("__URL__/pointLevel", {id: id, target: target}, function(msg) {
                if (msg) {
                    if (msg.status) {
                        $("a[href=\"javascript:selectLevel('" + id + "')\"]").text(targetName);
                        var difficultyObj = $("a[href=\"javascript:selectLevel('" + id + "')\"]").parent("td").siblings("td").find(".difficulty");
                        switch(msg.data){
                            case 0:
                                difficultyObj.text("无");
                                break;
                            case 1:
                                difficultyObj.text("初级");
                                break;
                            case 2:
                                difficultyObj.text("中级");
                                break;
                            case 3:
                                difficultyObj.text("高级");
                                break;
                            default:
                                break;
                        }
                        if(msg.data==0){
                            $("a[href=\"javascript:selectLevel('" + id + "')\"]").parent("td").siblings("td").find(".difficulty").text("无");
                        }
                        select.remove();
                        $("a[href=\"javascript:selectLevel('" + id + "')\"]").show();
                    }
                }
                $("#load_dialog").window("close");
            }, "json")
        })
    }
</script>
</html>
